.
|____index.css
|____context
| |____DataContext.tsx
|____server
| |____temp-uploads
| |____routes
| | |____photos.js
| | |____projects.js
| | |____customers.js
| | |____calendar.js
| | |____search.js
| | |____restore.js
| | |____samples.js
| | |____installers.js
| | |____orders.js
| | |____backup.js
| | |____jobs.js
| | |____sampleCheckouts.js
| | |____change-orders.js
| | |____quotes.js
| |____index.js
| |____uploads
| |____db.js
| |____utils.js
| |____tree.txt
|____backup.bak
|____package-lock.json
|____vite.config.ts
|____tsconfig.json
|____App.tsx
|____services
| |____quoteService.ts
| |____jobService.ts
| |____customerService.ts
| |____projectService.ts
| |____sampleCheckoutService.ts
| |____changeOrderService.ts
| |____materialOrderService.ts
| |____installerService.ts
| |____sampleService.ts
|____docker-compose.yml
|____Dockerfile
|____index.js.bak
|____.env
|____temp-uploads
|____.dockerignore
|____.gitignore
|____src
|____project_1old.txt
|____components
| |____SampleCheckoutsSection.tsx
| |____AddSampleInlineModal.tsx
| |____FinalizeJobSection.tsx
| |____SampleSelector.tsx
| |____ProjectInfoHeader.tsx
| |____Layout.tsx
| |____RestoreForm.tsx
| |____EditInstallerModal.tsx
| |____ChangeOrderSection.tsx
| |____PrintableCheckout.tsx
| |____QrScanner.tsx
| |____UniversalSearch.tsx
| |____CollapsibleSection.tsx
| |____SampleDetailModal.tsx
| |____MaterialOrdersSection.tsx
| |____EditChangeOrderModal.tsx
| |____EditProjectModal.tsx
| |____QuickCheckoutModal.tsx
| |____EditCustomerModal.tsx
| |____QuotesSection.tsx
| |____ProjectSelector.tsx
| |____CustomerSelector.tsx
|____metadata.json
|____package.json
|____schema.sql
|____types.ts
|____Dockerfile.server
|____index.html
|____tree.txt
|____README.md
|____index.tsx
|____pages
| |____CustomerDetail.tsx
| |____InstallerDetail.tsx
| |____CalendarView.tsx
| |____Settings.tsx
| |____SampleLibrary.tsx
| |____CustomerList.tsx
| |____InstallerList.tsx
| |____Dashboard.tsx
| |____ProjectDetail.tsx
| |____QuoteDetail.tsx
|____data
| |____mockData.ts
|____project.txt




### Project Overview

Joblogger is a full-stack web application designed to be a comprehensive management tool for small contracting businesses, such as flooring installers. It provides a single, centralized platform to track the entire lifecycle of a job, from initial customer inquiry to final completion.

The application is built to handle the complex, real-world workflows of a contracting business. Key functionalities include:

*   **Customer Relationship Management (CRM):** Create, view, and edit a complete list of customers.
*   **Project Tracking:** Manage individual jobs for each customer, each with its own intelligent status (e.g., `New`, `Quoting`, `Scheduled`, `Completed`) that updates automatically based on user actions.
*   **Sample & Inventory Management:** Maintain a central "Sample Library" of materials, and manage a robust multi-step checkout/return process for samples on a per-project basis.
*   **Installer & Schedule Management:** Manage a list of installers, assign them to jobs via quotes, and view their schedules on a color-coded, interactive calendar to prevent conflicts.
*   **Financials:** Create, edit, and manage quotes with detailed cost breakdowns. Track change orders, calculate required deposits, and view the final balance due for each job.
*   **Material Ordering:** Place and track material orders for scheduled jobs.

The entire application is built on a modern, robust technology stack, including a React (TypeScript) frontend, a Node.js (Express) backend API, and a persistent PostgreSQL database. The full stack is containerized with Docker for a stable, portable, and easily reproducible development and deployment environment.

---

### Features We've Built Together (Latest Session)

This has been a massive session focused on architectural improvements, completing core functionality, and adding major new features.

1.  **Full-Stack Architectural Overhaul (Major Improvement):**
    *   **Backend Refactor:** Migrated the entire backend from a single `server/index.js` file to a clean, router-based architecture. Each API entity (customers, projects, etc.) now lives in its own file in `server/routes/`, dramatically improving maintainability.
    *   **Frontend Refactor:** Created a dedicated **Service Layer** (`src/services/`). All `fetch` calls and API logic have been moved out of `DataContext.tsx` and into dedicated service files (`customerService.ts`, `projectService.ts`, etc.), making the data context a pure state manager and improving code reusability and testability.
    *   **Docker Architecture:** Corrected the `docker-compose.yml` to use a proper multi-service architecture (`app`, `server`, `db`), solving critical networking and DNS issues (`EAI_AGAIN`) and establishing a robust, industry-standard setup.

2.  **Comprehensive "Delete" Functionality (Core CRUD Complete):**
    *   **Pattern Established:** Built a reusable, safe deletion pattern with backend pre-flight checks and clear frontend feedback.
    *   **Full Implementation:** Implemented full-stack delete functionality for **Samples**, **Customers**, **Projects**, and **Installers**.
    *   **Advanced Logic:** The backend now includes critical business rule enforcement, such as preventing the deletion of a customer with projects, an installer with quotes, or a sample in a material order (`409 Conflict`), and handling complex cascade deletes for projects.

3.  **"Quick Checkout" & QR Code System (New Major Feature):**
    *   **UI/UX:** Built a new "Quick Checkout" modal, accessible from the Dashboard, that guides the user through a fast, single-page workflow to check out samples.
    *   **Component Architecture:** Created a suite of reusable components for the checkout process, including `CustomerSelector`, `ProjectSelector`, and `SampleSelector`, with on-the-fly creation capabilities.
    *   **Backend QR Generation:** Built a new `GET /api/samples/:id/qr` endpoint that generates and serves a unique QR code image for any sample in the database.
    *   **Frontend QR Display:** The `SampleDetailModal` now displays the QR code for each sample, with a "Print" button for easy labeling of physical items.
    *   **Live QR Scanning:** Integrated a camera-based QR code scanner (`html5-qrcode`) into the "Quick Checkout" flow, allowing users to scan physical samples to instantly add them to their checkout list. Streamlined the mobile UX by defaulting to the rear camera and providing a "scan-and-close" experience.

4.  **Flexible Business Logic: "Installation Types":**
    *   **Architecture:** Implemented a new "Installation Type" (`Managed`, `Materials Only`, `Unmanaged`) on all quotes to handle different sales scenarios.
    *   **Dynamic UI:** The "Add/Edit Quote" modal is now intelligent, hiding irrelevant fields (like labor costs or installer selection) based on the chosen installation type.
    *   **Decoupled Workflow:** Decoupled material ordering from project scheduling, allowing users to order materials for "Materials Only" sales as soon as a quote is accepted.
    *   **Smarter Calendar:** The calendar now correctly filters its view, only displaying jobs with a "Managed Installation" type, keeping the schedule clean and relevant.

5.  **Full Mobile Responsiveness:**
    *   **Main Layout:** Completely refactored `Layout.tsx` to be mobile-first. The sidebar is now a collapsible "hamburger" menu on mobile devices.
    *   **Pages & Grids:** Updated all major pages (`Dashboard`, `CustomerList`, `InstallerList`, `ProjectDetail`) with responsive grid classes, ensuring they stack correctly and are fully usable on a phone screen.
    *   **Modals:** Adjusted modals like `SampleDetailModal` to be responsive and prevent overflow on small screens.

6.  **Critical Bug Smashing & Stability:**
    *   **Mixed Content:** Diagnosed and permanently fixed a persistent "Mixed Content" error by cleaning bad data from the database and ensuring only relative URLs are used for images.
    *   **Docker & Networking:** Solved multiple `docker-compose` and internal networking errors, culminating in the move to a stable multi-service architecture.
    *   **Scanner Stability:** Fixed a critical bug causing the mobile QR scanner to freeze on a successful scan by stabilizing the component's state and effects.
    *   **Workflow Logic:** Corrected a bug that prematurely set a project's status to "Sample Checkout" during the Quick Checkout flow.

---

### Updated Roadmap (Features We Haven't Implemented)

We've made incredible progress, completing almost all of the core CRUD functionality and adding several major new features.

*   **Editing (Nearly Complete):**
    *   While most entities are fully editable, we still have no way to edit a **Material Order** after it has been created.

*   **Deleting (Nearly Complete):**
    *   The only remaining core entity that cannot be deleted is a **Material Order**.

*   **File Uploads (Paperwork):**
    *   The core file upload system is proven. The next step is to apply it to the "Signed Paperwork" section on the Job Details page to allow for uploading and storing documents like PDFs.

*   **"On-the-Fly" Sample Creation:**
    *   During the "Quick Checkout" flow, there is currently no way to add a brand-new, uncatalogued sample to the system. This could be added to the sample search results.

*   **Advanced Business Logic:**
    *   Material ETA vs. Job Start Date Awareness (UI warning).
    *   Dynamic defaults for quote percentages based on Project Type.
    *   Drag-and-drop rescheduling on the calendar.

*   **Authentication & Users:**
    *   The app remains a single-user system. This is a major future epic.

    Session 4:

    Changes We've Made in This Session

This was a massive session focused on adding a critical new administrative feature, enhancing existing workflows, and hardening the application's core architecture.
1. Full-Stack Backup & Restore System (New Major Feature)

We built a complete, UI-driven system for backing up and restoring the application's critical data, designed to be run by the user without needing command-line access.

    New "Settings" Page:

        Created a new dedicated page at /settings to house administrative functions.

        Added a link to this page in the main sidebar navigation.

    Robust Backup Functionality:

        Backend API (backup.js): Built two new GET endpoints (/api/backup/database and /api/backup/images) that generate and stream ZIP archives to the user.

        Reliable Database Dumps: The final implementation is robust. It uses pg_dump to save a complete backup to a temporary file on the server first, ensuring the file is not corrupted, before zipping and sending it. This fixed a critical bug where streaming directly was creating empty/broken backups.

        UI Integration: The Settings page has "Download Database" and "Download Images" buttons that work correctly.

    Disaster-Proof Restore Functionality:

        Backend API (restore.js): Built two new POST endpoints to handle file uploads for restoring the database and images.

        "Atomic Swap" for Images: Solved a critical EBUSY: resource busy or locked error by implementing an "atomic swap" strategy. The code no longer tries to delete the live uploads directory. Instead, it unzips the backup to a temporary uploads_new directory and then instantly renames the folders, which is a foolproof way to avoid file-locking conflicts.

        Correct Tooling: The server is now built with the correct version of the postgresql-client tools (pg_restore), fixing version mismatch errors during the restore process.

        UI Integration: The "Danger Zone" on the Settings page now contains working forms to upload and restore the database and images, complete with warnings and page reloads on success.

2. Architectural & Docker Hardening (Major Stability Improvement)

The process of debugging the Backup/Restore feature forced us to make significant, permanent improvements to the Docker architecture.

    Dedicated Server Dockerfile (Dockerfile.server): We created a separate, dedicated Dockerfile for the backend service. This allowed us to install the necessary postgresql-client tools without bloating the frontend image.

    Eliminated Volume Conflicts (The EBUSY Fix): We completely reconfigured the docker-compose.yml file to solve the root cause of the file-locking issues.

        The server service no longer uses a volume for its source code, running the code baked into its image for maximum stability.

        The app (frontend) service now uses specific, surgical volume mounts (./src:/app/src, etc.) instead of mounting the entire project. This prevents Vite's file watcher from "spying on" and locking the server's filesâ€”the true cause of the EBUSY error.

        A dedicated volume for server/uploads was created to ensure user-uploaded images are persistent and correctly stored on the host machine.

3. "Extend Checkout" Functionality (New Feature)

We added the ability for a user to extend a sample's due date by two days from multiple places in the UI.

    Full Stack Implementation: This involved creating a new PATCH endpoint, a new service function (patchSampleCheckout), and a new extendSampleCheckout function in the DataContext.

    UI Integration: The "Extend" button was successfully added and is fully functional in all three requested locations:

        The Job Detail page's checkout list.

        The Sample Detail modal.

        The Sample Library card view.

4. Critical Bug Fixes & Workflow Enhancements

    Fixed "Return" Button Race Condition: Solved a bug where returning a sample from the Sample Library card would fail because the UI was re-fetching data too quickly. We fixed this by removing the aggressive fetchInitialData() call and trusting the local state update.

    Fixed "Window Slamming Shut": Corrected the behavior of the SampleDetailModal so that returning a sample no longer causes the modal to close immediately, improving the user experience.

Features We Talked About But Didn't Implement

We successfully completed all the primary goals of this session. The remaining items are primarily quality-of-life improvements and future enhancements related to the features we just built.

    Graceful "Empty State" Handling: We observed that when the database is completely empty (after a docker-compose down -v), some parts of the UI, like the calendar, can get stuck in a "Loading..." state. We have not yet added the frontend logic to gracefully handle this "zero data" scenario and show a message like "No data found. Try restoring from a backup."

    Automatic Pre-Restore Snapshot: The current restore process is destructive. We discussed but did not implement a safety feature where clicking "Restore" would first automatically trigger a new backup of the current state before proceeding with the overwrite.

    Automated, Scheduled Backups: Our initial brainstorming mentioned automated, off-site backups (e.g., using a cron job to run the backup and upload it to a cloud service). We intentionally pivoted to a UI-driven local backup system, so the automated/cloud functionality remains unimplemented.